local function duplicatePet(petName)
    local Loads = require(game.ReplicatedStorage.Fsys).load
    local ClientData = Loads("ClientData")
    local InventoryDB = Loads("InventoryDB")
    local Inventory = ClientData.get("inventory")
    local PetHandler = Loads("PetHandler")
    local RideRemote = game.ReplicatedStorage:FindFirstChild("RidePetRemote")

    if not RideRemote then
        warn("❌ RidePetRemote not found in ReplicatedStorage.")
        return false
    end

    local function generate_prop()
        return {
            flyable = true,
            rideable = true,
            neon = petType == "NFR" or petType == "MFR",
            mega_neon = petType == "MFR",
            age = 1
        }
    end

    local function cloneTable(original)
        local copy = {}
        for key, value in pairs(original) do
            if type(value) == "table" then
                copy[key] = cloneTable(value)
            else
                copy[key] = value
            end
        end
        return copy
    end

    for category_name, category_table in pairs(InventoryDB) do
        for id, item in pairs(category_table) do
            if category_name == "pets" and item.name:lower() == petName:lower() then
                local rawUUID = game.HttpService:GenerateGUID(false)
                local fullUUID = "uuid_" .. rawUUID
                local n_item = cloneTable(item)

                n_item["unique"] = fullUUID
                n_item["category"] = "pets"
                n_item["properties"] = generate_prop()
                n_item["newness_order"] = math.random(1, 900000)

                if not Inventory[category_name] then
                    Inventory[category_name] = {}
                end

                Inventory[category_name][fullUUID] = n_item
                print("✅ Added pet to inventory with UUID:", fullUUID)

                -- Try equipping
                local success, err = pcall(function()
                    PetHandler.equip(fullUUID)
                end)

                if not success then
                    warn("❌ Failed to equip pet:", err)
                else
                    print("✅ Pet equipped.")
                end

                -- Then ride
                task.delay(0.3, function()
                    local success2, err2 = pcall(function()
                        RideRemote:FireServer(fullUUID)
                        print("✅ RideRemote fired for:", fullUUID)
                    end)

                    if not success2 then
                        warn("❌ Failed to ride pet:", err2)
                    end
                end)

                return true
            end
        end
    end

    return false
end
